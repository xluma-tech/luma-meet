# Floating Window Architecture

## Before (Broken) âŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Tab (Meeting)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Main Meeting UI                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Floating Window (Overlay)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ âŒ Disappears when tab      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    switches                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

When user switches tabs:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Tab (Other Website)            â”‚
â”‚  âŒ Video is gone!                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## After (Fixed) âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Tab (Meeting)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Main Meeting UI                  â”‚  â”‚
â”‚  â”‚  [Floating Window Enabled]        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ window.open()
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Separate Window        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“¹ Your Video   â”‚  â”‚
â”‚  â”‚  âœ… Always       â”‚  â”‚
â”‚  â”‚     Visible      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

When user switches tabs:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Tab (Other Website)            â”‚
â”‚  âœ… Video still visible in popup!       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
         â”‚ Still visible!
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Separate Window        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“¹ Your Video   â”‚  â”‚
â”‚  â”‚  âœ… Still here!  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RoomPage Component                                  â”‚
â”‚                                                      â”‚
â”‚  const [showFloatingWindow, setShowFloatingWindow]  â”‚
â”‚                                                      â”‚
â”‚  useEffect(() => {                                   â”‚
â”‚    if (isPageHidden && !isPiPActive) {              â”‚
â”‚      setShowFloatingWindow(true) â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚    }                                      â”‚          â”‚
â”‚  })                                       â”‚          â”‚
â”‚                                           â”‚          â”‚
â”‚  return (                                 â”‚          â”‚
â”‚    <FloatingWindow                        â”‚          â”‚
â”‚      isVisible={showFloatingWindow} â—„â”€â”€â”€â”€â”€â”˜          â”‚
â”‚      stream={localStreamRef.current}                 â”‚
â”‚      userName={userName}                             â”‚
â”‚      onClose={() => setShowFloatingWindow(false)}    â”‚
â”‚    />                                                â”‚
â”‚  )                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FloatingWindow Component                            â”‚
â”‚                                                      â”‚
â”‚  useEffect(() => {                                   â”‚
â”‚    if (isVisible && stream) {                        â”‚
â”‚      const popup = window.open(...)  â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚      setupPopupWindow(popup, stream)  â”‚      â”‚      â”‚
â”‚      updatePopupStream(popup, stream) â”‚      â”‚      â”‚
â”‚    }                                  â”‚      â”‚      â”‚
â”‚  }, [isVisible, stream])              â”‚      â”‚      â”‚
â”‚                                       â”‚      â”‚      â”‚
â”‚  return null // No UI in main window  â”‚      â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚      â”‚
                                        â†“      â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Popup Window                 â”‚
                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                        â”‚  â”‚ HTML Document           â”‚  â”‚
                        â”‚  â”‚ - Video element         â”‚  â”‚
                        â”‚  â”‚ - Inline CSS            â”‚  â”‚
                        â”‚  â”‚ - JavaScript            â”‚  â”‚
                        â”‚  â”‚ - Close button          â”‚  â”‚
                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  State Flow                                         â”‚
â”‚                                                     â”‚
â”‚  User switches tab                                  â”‚
â”‚         â†“                                           â”‚
â”‚  document.hidden = true                             â”‚
â”‚         â†“                                           â”‚
â”‚  isPageHidden = true                                â”‚
â”‚         â†“                                           â”‚
â”‚  isPiPActive? â”€â”€Noâ”€â”€â†’ showFloatingWindow = true     â”‚
â”‚         â”‚                      â†“                    â”‚
â”‚        Yes                window.open()             â”‚
â”‚         â†“                      â†“                    â”‚
â”‚  Use PiP instead        Popup appears               â”‚
â”‚                                                     â”‚
â”‚  User returns to tab                                â”‚
â”‚         â†“                                           â”‚
â”‚  document.hidden = false                            â”‚
â”‚         â†“                                           â”‚
â”‚  isPageHidden = false                               â”‚
â”‚         â†“                                           â”‚
â”‚  showFloatingWindow = false                         â”‚
â”‚         â†“                                           â”‚
â”‚  popup.close()                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Component Lifecycle                                â”‚
â”‚                                                     â”‚
â”‚  1. Mount                                           â”‚
â”‚     â””â”€â†’ Initialize refs                            â”‚
â”‚                                                     â”‚
â”‚  2. isVisible = true                                â”‚
â”‚     â””â”€â†’ Check if popup already open                â”‚
â”‚         â”œâ”€â†’ Yes: Update existing popup             â”‚
â”‚         â””â”€â†’ No: Create new popup                   â”‚
â”‚             â”œâ”€â†’ window.open()                      â”‚
â”‚             â”œâ”€â†’ Inject HTML/CSS/JS                 â”‚
â”‚             â”œâ”€â†’ Set video stream                   â”‚
â”‚             â””â”€â†’ Start monitoring                   â”‚
â”‚                                                     â”‚
â”‚  3. Stream changes                                  â”‚
â”‚     â””â”€â†’ Update popup video element                 â”‚
â”‚                                                     â”‚
â”‚  4. User closes popup                               â”‚
â”‚     â””â”€â†’ Detect via interval check                  â”‚
â”‚         â””â”€â†’ Call onClose callback                  â”‚
â”‚             â””â”€â†’ Cleanup                            â”‚
â”‚                                                     â”‚
â”‚  5. isVisible = false                               â”‚
â”‚     â””â”€â†’ Close popup                                â”‚
â”‚         â””â”€â†’ Clear interval                         â”‚
â”‚             â””â”€â†’ Cleanup refs                       â”‚
â”‚                                                     â”‚
â”‚  6. Unmount                                         â”‚
â”‚     â””â”€â†’ Final cleanup                              â”‚
â”‚         â”œâ”€â†’ Close popup if open                    â”‚
â”‚         â”œâ”€â†’ Clear all intervals                    â”‚
â”‚         â””â”€â†’ Release resources                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error Scenarios                                    â”‚
â”‚                                                     â”‚
â”‚  Popup Blocked                                      â”‚
â”‚     â”œâ”€â†’ window.open() returns null                 â”‚
â”‚     â”œâ”€â†’ Log error                                  â”‚
â”‚     â”œâ”€â†’ Call onClose()                             â”‚
â”‚     â””â”€â†’ User sees browser notification             â”‚
â”‚                                                     â”‚
â”‚  Stream Not Available                               â”‚
â”‚     â”œâ”€â†’ Check if stream exists                     â”‚
â”‚     â”œâ”€â†’ Show loading state                         â”‚
â”‚     â””â”€â†’ Retry when stream available                â”‚
â”‚                                                     â”‚
â”‚  Video Play Failed                                  â”‚
â”‚     â”œâ”€â†’ Catch play() promise rejection             â”‚
â”‚     â”œâ”€â†’ Log error                                  â”‚
â”‚     â””â”€â†’ Continue (non-critical)                    â”‚
â”‚                                                     â”‚
â”‚  Popup Closed by User                               â”‚
â”‚     â”œâ”€â†’ Detect via interval check                  â”‚
â”‚     â”œâ”€â†’ Call onClose()                             â”‚
â”‚     â””â”€â†’ Clean up resources                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Browser Compatibility

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Support Matrix                             â”‚
â”‚                                                     â”‚
â”‚  Chrome/Edge                                        â”‚
â”‚     â”œâ”€â†’ âœ… Full support                            â”‚
â”‚     â”œâ”€â†’ âœ… window.open() works                     â”‚
â”‚     â”œâ”€â†’ âœ… Always-on-top works                     â”‚
â”‚     â””â”€â†’ âœ… Best experience                         â”‚
â”‚                                                     â”‚
â”‚  Firefox                                            â”‚
â”‚     â”œâ”€â†’ âœ… Full support                            â”‚
â”‚     â”œâ”€â†’ âš ï¸  May need popup permission              â”‚
â”‚     â”œâ”€â†’ âœ… Always-on-top works                     â”‚
â”‚     â””â”€â†’ âœ… Good experience                         â”‚
â”‚                                                     â”‚
â”‚  Safari (Desktop)                                   â”‚
â”‚     â”œâ”€â†’ âœ… Full support                            â”‚
â”‚     â”œâ”€â†’ âš ï¸  May need popup permission              â”‚
â”‚     â”œâ”€â†’ âš ï¸  Always-on-top limited                  â”‚
â”‚     â””â”€â†’ âœ… Good experience                         â”‚
â”‚                                                     â”‚
â”‚  Mobile Browsers                                    â”‚
â”‚     â”œâ”€â†’ âš ï¸  Limited popup support                  â”‚
â”‚     â”œâ”€â†’ âŒ window.open() restricted                â”‚
â”‚     â””â”€â†’ ğŸ”„ Falls back to in-page overlay           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Performance Characteristics                        â”‚
â”‚                                                     â”‚
â”‚  Memory Usage                                       â”‚
â”‚     â”œâ”€â†’ Popup window: ~5-10 MB                     â”‚
â”‚     â”œâ”€â†’ Video stream: Shared (no duplication)      â”‚
â”‚     â””â”€â†’ Total overhead: Minimal                    â”‚
â”‚                                                     â”‚
â”‚  CPU Usage                                          â”‚
â”‚     â”œâ”€â†’ Popup rendering: <1%                       â”‚
â”‚     â”œâ”€â†’ Interval checking: Negligible              â”‚
â”‚     â””â”€â†’ Video decoding: Same as main window        â”‚
â”‚                                                     â”‚
â”‚  Network                                            â”‚
â”‚     â”œâ”€â†’ No additional bandwidth                    â”‚
â”‚     â””â”€â†’ Stream is shared, not duplicated           â”‚
â”‚                                                     â”‚
â”‚  Startup Time                                       â”‚
â”‚     â”œâ”€â†’ Popup creation: <100ms                     â”‚
â”‚     â”œâ”€â†’ Content injection: <50ms                   â”‚
â”‚     â””â”€â†’ Video start: <200ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

**Old Approach**: In-page overlay (disappears with tab)
**New Approach**: Separate window (always visible)

**Key Benefit**: Video remains visible when:
- âœ… Switching tabs
- âœ… Minimizing browser
- âœ… Working in other apps

**Implementation**: Clean, production-ready, well-documented
